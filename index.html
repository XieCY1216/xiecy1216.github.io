<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>博饼小游戏 - 概率模拟器</title>
  <!-- 引入外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            accent: '#F59E0B',
            danger: '#EF4444',
            dark: '#1F2937',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>

  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .dice-rotate {
        animation: rotate 1s ease-in-out;
      }
      @keyframes rotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .btn-primary {
        @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg;
      }
      .btn-danger {
        @apply bg-danger hover:bg-danger/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg;
      }
      .stat-card {
        @apply bg-white rounded-xl shadow-md p-4 transition-all duration-300 hover:shadow-lg;
      }
      .dice {
        @apply flex items-center justify-center w-16 h-16 md:w-20 md:h-20 rounded-xl text-2xl md:text-3xl font-bold shadow-md transition-all duration-300 border-2 border-gray-200;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-dark">
  <!-- 顶部导航 -->
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-2xl md:text-3xl font-bold text-primary">
        <i class="fa fa-dice mr-2"></i>博饼小游戏
      </h1>
      <div class="text-sm text-gray-500">
        概率模拟器
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 py-8">
    <!-- 游戏区域 -->
    <section class="mb-12">
      <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 transform transition-all duration-300 hover:shadow-xl">
        <h2 class="text-xl md:text-2xl font-bold mb-6 text-center">博饼游戏</h2>

        <!-- 骰子展示区 -->
        <div class="flex flex-wrap justify-center gap-4 md:gap-6 mb-8">
          <div id="dice-1" class="dice bg-white">1</div>
          <div id="dice-2" class="dice bg-white">2</div>
          <div id="dice-3" class="dice bg-white">3</div>
          <div id="dice-4" class="dice bg-white">4</div>
          <div id="dice-5" class="dice bg-white">5</div>
          <div id="dice-6" class="dice bg-white">6</div>
        </div>

        <!-- 当前结果 -->
        <div id="result-display" class="text-center mb-6 p-4 bg-gray-50 rounded-xl min-h-[60px] flex items-center justify-center">
          <p class="text-lg md:text-xl font-medium text-gray-700">点击下方按钮开始博饼</p>
        </div>

        <!-- 控制按钮区（仅保留手动博饼和重置） -->
        <div class="flex flex-wrap justify-center gap-4">
          <button id="roll-btn" class="btn-primary flex items-center">
            <i class="fa fa-play mr-2"></i>博饼
          </button>
          <button id="reset-btn" class="btn-danger flex items-center">
            <i class="fa fa-trash mr-2"></i>重置数据
          </button>
        </div>

        <!-- 统计概览 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8">
          <div class="stat-card">
            <p class="text-sm text-gray-500 mb-1">总次数</p>
            <p id="total-rolls" class="text-2xl font-bold text-primary">0</p>
          </div>
          <div class="stat-card">
            <p class="text-sm text-gray-500 mb-1">最近结果</p>
            <p id="last-result" class="text-xl font-medium text-gray-700">-</p>
          </div>
          <div class="stat-card">
            <p class="text-sm text-gray-500 mb-1">状元出现次数</p>
            <p id="champion-count" class="text-2xl font-bold text-accent">0</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 图表和统计表格区域 -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- 概率图表 -->
      <section class="lg:col-span-1">
        <div class="bg-white rounded-2xl shadow-lg p-6 h-full transform transition-all duration-300 hover:shadow-xl">
          <h2 class="text-xl font-bold mb-4">概率对比图</h2>
          <div class="h-[400px]">
            <canvas id="probability-chart"></canvas>
          </div>
        </div>
      </section>

      <!-- 统计表格 -->
      <section class="lg:col-span-2">
        <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:shadow-xl">
          <h2 class="text-xl font-bold mb-4">详细统计数据</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead>
                <tr>
                  <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">结果</th>
                  <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">出现次数</th>
                  <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">当前概率</th>
                  <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">理论概率</th>
                  <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">相对误差</th>
                </tr>
              </thead>
              <tbody id="stats-table" class="bg-white divide-y divide-gray-200">
                <!-- 表格内容将通过JavaScript动态生成 -->
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-dark text-white mt-12 py-6">
    <div class="container mx-auto px-4 text-center">
      <p>© 2023 博饼小游戏模拟器 | 基于传统博饼规则设计</p>
      <p class="text-sm text-gray-400 mt-2">博饼是福建地区特有的传统节日游戏，通常在中秋节期间进行</p>
    </div>
  </footer>

  <script>
    // 博饼结果类型定义，包含理论概率
    const resultTypes = [
      { id: 'champion_flower', name: '状元插金花', theoretical: 15 / 46656 },
      { id: 'six_red', name: '六抔红', theoretical: 1 / 46656 },
      { id: 'six_black', name: '六抔黑', theoretical: 5 / 46656 },
      { id: 'five_red', name: '五红', theoretical: 30 / 46656 },
      { id: 'five_same', name: '五子登科', theoretical: 150 / 46656 },
      { id: 'champion', name: '状元', theoretical: 360 / 46656 },
      { id: 'straight', name: '对堂', theoretical: 720 / 46656 },
      { id: 'three_red', name: '三红', theoretical: 2500 / 46656 },
      { id: 'four_same', name: '四进', theoretical: 1875 / 46656 },
      { id: 'two_red', name: '二举', theoretical: 9300 / 46656 },
      { id: 'one_red', name: '一秀', theoretical: 17400 / 46656 },
      { id: 'no_prize', name: '无奖', theoretical: 14200 / 46656 }
    ];

    // 初始化统计数据（移除自动博饼相关变量）
    let stats = {};
    let totalRolls = 0;
    let lastRollTime = 0;

    // 初始化统计数据
    function initStats() {
      stats = {};
      totalRolls = 0;
      
      resultTypes.forEach(type => {
        stats[type.id] = {
          count: 0,
          name: type.name,
          theoretical: type.theoretical
        };
      });

      updateUI();
    }

    // 随机生成6个骰子的结果
    function rollDice() {
      const dice = [];
      for (let i = 0; i < 6; i++) {
        dice.push(Math.floor(Math.random() * 6) + 1);
      }
      return dice;
    }

    // 判定博饼结果（按优先级从高到低）
    function determineResult(dice) {
      // 排序骰子以便于分析
      const sorted = [...dice].sort((a, b) => a - b);
      const counts = {};

      // 统计每个数字出现的次数
      sorted.forEach(num => {
        counts[num] = (counts[num] || 0) + 1;
      });

      const countValues = Object.values(counts).sort((a, b) => b - a);

      // 状元插金花：四个4+两个1
      if (counts[4] === 4 && counts[1] === 2) {
        return 'champion_flower';
      }

      // 六抔红：六个4
      if (counts[4] === 6) {
        return 'six_red';
      }

      // 六抔黑：六个其他数字
      if (countValues[0] === 6 && counts[4] !== 6) {
        return 'six_black';
      }

      // 五红：5个4+非4
      if (counts[4] === 5) {
        return 'five_red';
      }

      // 五子登科：五个相同的其他数
      if (countValues[0] === 5 && counts[4] !== 5) {
        return 'five_same';
      }

      // 状元：四个4带其他两个任意数
      if (counts[4] === 4) {
        return 'champion';
      }

      // 对堂：摇出顺子，123456
      if (sorted.join(',') === '1,2,3,4,5,6') {
        return 'straight';
      }

      // 三红：三个4
      if (counts[4] === 3) {
        return 'three_red';
      }

      // 四进：除了4以外的四个相同的数
      if (countValues[0] === 4 && counts[4] !== 4) {
        return 'four_same';
      }

      // 二举：两个4
      if (counts[4] === 2) {
        return 'two_red';
      }

      // 一秀：一个4
      if (counts[4] === 1) {
        return 'one_red';
      }

      // 无奖
      return 'no_prize';
    }

    // 更新骰子显示
    function updateDiceDisplay(dice, animate = true) {
      dice.forEach((value, index) => {
        const diceElement = document.getElementById(`dice-${index + 1}`);
        diceElement.textContent = value;

        // 重置样式
        diceElement.classList.remove('bg-red-100', 'text-danger', 'dice-rotate', 'bg-white', 'text-dark');

        // 如果是1或4，添加红色样式
        if (value === 1 || value === 4) {
          diceElement.classList.add('bg-red-100', 'text-danger');
        } else {
          diceElement.classList.add('bg-white', 'text-dark');
        }

        // 添加旋转动画
        if (animate) {
          diceElement.classList.add('dice-rotate');
        }
      });
    }

    // 更新结果显示
    function updateResultDisplay(resultId) {
      const resultElement = document.getElementById('result-display');
      const resultType = resultTypes.find(type => type.id === resultId);

      resultElement.innerHTML = `<p class="text-lg md:text-xl font-medium text-primary">结果: ${resultType.name}</p>`;

      // 更新最近结果
      document.getElementById('last-result').textContent = resultType.name;
    }

    // 更新统计表格
    function updateStatsTable() {
      const tableBody = document.getElementById('stats-table');
      tableBody.innerHTML = '';

      // 计算状元出现次数（所有状元级别结果）
      let championCount = 0;
      ['champion_flower', 'six_red', 'six_black', 'five_red', 'five_same', 'champion'].forEach(id => {
        championCount += stats[id].count;
      });
      document.getElementById('champion-count').textContent = championCount;

      resultTypes.forEach(type => {
        const stat = stats[type.id];
        const currentProb = totalRolls > 0 ? stat.count / totalRolls : 0;
        const theoreticalProb = type.theoretical;
        const error = theoreticalProb > 0
          ? Math.abs((currentProb - theoreticalProb) / theoreticalProb)
          : 0;

        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';

        row.innerHTML = `
          <td class="px-4 py-3 whitespace-nowrap">${stat.name}</td>
          <td class="px-4 py-3 whitespace-nowrap">${stat.count}</td>
          <td class="px-4 py-3 whitespace-nowrap">${(currentProb * 100).toFixed(4)}%</td>
          <td class="px-4 py-3 whitespace-nowrap">${(theoreticalProb * 100).toFixed(4)}%</td>
          <td class="px-4 py-3 whitespace-nowrap ${error > 0.1 ? 'text-danger' : 'text-gray-600'}">
            ${(error * 100).toFixed(4)}%
          </td>
        `;

        tableBody.appendChild(row);
      });
    }

    // 概率对比图表
    let probabilityChart;
    function initProbabilityChart() {
      try {
        if (typeof Chart === 'undefined') {
          console.warn('Chart.js尚未加载，将在稍后重试初始化图表');
          setTimeout(initProbabilityChart, 500);
          return;